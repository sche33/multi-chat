<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basit P2P Sohbet</title>
    <style>
        :root {
            --primary: #4285f4;
            --secondary: #34a853;
            --error: #ea4335;
            --background: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Login Ekranı */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .login-card {
            background: var(--card);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-card h1 {
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 20px;
            cursor: pointer;
            border: 3px solid var(--primary);
        }
        
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #3367d6;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .error {
            color: var(--error);
            margin: 10px 0;
        }
        
        /* Sohbet Ekranı */
        .chat-container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 300px;
            background: var(--card);
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px;
            background: var(--primary);
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--card);
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
        }
        
        .message.sent {
            background-color: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message.received {
            background-color: #e9e9e9;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        .message-info {
            font-size: 12px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .input-area {
            display: flex;
            padding: 15px;
            background: var(--card);
            border-top: 1px solid #ddd;
        }
        
        .input-area input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-button {
            background: var(--secondary);
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .user-list {
            padding: 15px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .user-item:hover {
            background-color: #f0f0f0;
        }
        
        .user-item.active {
            background-color: #e3f2fd;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: auto;
        }
        
        .online {
            background-color: var(--secondary);
        }
        
        .offline {
            background-color: var(--error);
        }
        
        .typing-indicator {
            font-size: 14px;
            color: #666;
            font-style: italic;
            height: 20px;
            padding: 0 15px;
        }
        
        .file-message {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .file-icon {
            margin-right: 8px;
        }
        
        .media-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 5px;
            cursor: pointer;
        }
        
        .progress-container {
            margin-top: 10px;
            display: none;
        }
        
        .progress-bar {
            height: 5px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Giriş Ekranı -->
        <div class="login-container" v-if="screen === 'login'">
            <div class="login-card">
                <h1>Sohbete Bağlan</h1>
                
                <img :src="profilePic || 'https://via.placeholder.com/150'" 
                     class="profile-pic" 
                     @click="triggerProfilePicUpload">
                <input type="file" id="profile-pic-upload" class="file-input" 
                       accept="image/*" @change="handleProfilePicChange">
                
                <input type="text" v-model="username" 
                       placeholder="Kullanıcı adınız" 
                       :disabled="loading">
                
                <button @click="login" :disabled="!username || loading">
                    <span v-if="!loading">Giriş Yap</span>
                    <span v-else>Bağlanıyor...</span>
                </button>
                
                <div class="error" v-if="error">{{ error }}</div>
            </div>
        </div>
        
        <!-- Sohbet Ekranı -->
        <div v-if="screen === 'chat'">
            <div class="chat-header">
                <div class="container">
                    P2P Sohbet - {{ username }}
                    <button @click="disconnect" style="float: right; width: auto; padding: 5px 10px;">
                        Çıkış Yap
                    </button>
                </div>
            </div>
            
            <div class="chat-container">
                <!-- Kullanıcı Listesi -->
                <div class="sidebar">
                    <div class="user-list">
                        <div class="user-item active">
                            <img :src="profilePic || 'https://via.placeholder.com/150'" class="user-avatar">
                            <span>{{ username }} (Siz)</span>
                            <span class="status-indicator online"></span>
                        </div>
                        
                        <div v-for="user in users" 
                             :key="user.peerId" 
                             class="user-item"
                             @click="selectUser(user.peerId)"
                             :class="{ active: activeUser === user.peerId }">
                            <img :src="user.profilePic || 'https://via.placeholder.com/150'" class="user-avatar">
                            <span>{{ user.username }}</span>
                            <span class="status-indicator" :class="user.online ? 'online' : 'offline'"></span>
                        </div>
                    </div>
                    
                    <div style="padding: 15px; border-top: 1px solid #ddd;">
                        <input type="text" v-model="newUser" placeholder="Kullanıcı adı">
                        <button @click="connectToUser" style="margin-top: 10px;">Bağlan</button>
                        <div class="error" v-if="connectionError">{{ connectionError }}</div>
                    </div>
                </div>
                
                <!-- Sohbet Alanı -->
                <div class="chat-area">
                    <div class="messages" ref="messages">
                        <div v-for="msg in filteredMessages" :key="msg.timestamp">
                            <div class="message-info">
                                <img :src="getProfilePic(msg.sender)" class="user-avatar">
                                {{ msg.sender }} - {{ formatTime(msg.timestamp) }}
                            </div>
                            <div :class="['message', msg.sender === username ? 'sent' : 'received']">
                                <div v-if="msg.type === 'text'">
                                    {{ msg.content }}
                                </div>
                                <div v-else-if="msg.type === 'file'">
                                    <div class="file-message">
                                        <svg class="file-icon" width="20" height="20" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                                        </svg>
                                        <div>
                                            <div>{{ msg.fileName }}</div>
                                            <div style="font-size: 12px;">{{ formatFileSize(msg.fileSize) }}</div>
                                            <a href="#" @click.prevent="downloadFile(msg)" style="font-size: 12px;">İndir</a>
                                        </div>
                                    </div>
                                </div>
                                <div v-else-if="msg.type === 'image'">
                                    <img :src="msg.content" class="media-preview" @click="showFullscreen(msg.content)">
                                </div>
                                <div v-else-if="msg.type === 'video'">
                                    <video controls class="media-preview">
                                        <source :src="msg.content">
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="typing-indicator">
                        {{ typingText }}
                    </div>
                    
                    <div class="input-area">
                        <label class="file-button" title="Dosya Gönder (50MB'a kadar)">
                            <svg width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                            </svg>
                            <input type="file" id="file-upload" class="file-input" 
                                   @change="handleFileUpload" :disabled="uploading">
                        </label>
                        
                        <input type="text" v-model="message" 
                               @keyup.enter="sendMessage"
                               @keyup="handleTyping"
                               placeholder="Mesajınızı yazın...">
                        
                        <button @click="sendMessage" :disabled="!message">
                            <svg width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="progress-container" v-if="uploading">
                        <div>Dosya gönderiliyor: {{ uploadProgress }}%</div>
                        <div class="progress-bar">
                            <div class="progress" :style="{ width: uploadProgress + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tam Ekran Medya Görüntüleyici -->
        <div v-if="fullscreenMedia" class="fullscreen-media" @click="fullscreenMedia = null">
            <img v-if="fullscreenMediaType === 'image'" :src="fullscreenMedia">
            <video v-else controls autoplay>
                <source :src="fullscreenMedia">
            </video>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    
    <script>
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
        
        new Vue({
            el: '#app',
            data: {
                screen: 'login',
                username: '',
                profilePic: null,
                loading: false,
                error: '',
                
                // Sohbet verileri
                peer: null,
                activeUser: null,
                users: [],
                messages: [],
                message: '',
                typingUsers: {},
                lastTypingTime: 0,
                typingTimeout: null,
                
                // Dosya gönderme
                uploading: false,
                uploadProgress: 0,
                fileToUpload: null,
                
                // Tam ekran medya
                fullscreenMedia: null,
                fullscreenMediaType: null,
                
                // Yeni kullanıcı bağlantısı
                newUser: '',
                connectionError: ''
            },
            computed: {
                filteredMessages() {
                    if (!this.activeUser) return [];
                    const otherUser = this.users.find(u => u.peerId === this.activeUser)?.username;
                    
                    return this.messages.filter(msg => 
                        (msg.sender === this.username && msg.receiver === otherUser) ||
                        (msg.sender === otherUser && msg.receiver === this.username)
                    ).sort((a, b) => a.timestamp - b.timestamp);
                },
                typingText() {
                    if (!this.activeUser) return '';
                    const user = this.users.find(u => u.peerId === this.activeUser);
                    if (!user || !this.typingUsers[this.activeUser]) return '';
                    return `${user.username} yazıyor...`;
                }
            },
            watch: {
                filteredMessages() {
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });
                }
            },
            methods: {
                // Yardımcı fonksiyonlar
                generatePeerId(username) {
                    return `p2p-chat-${username}`;
                },
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                },
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Byte';
                    const k = 1024;
                    const sizes = ['Byte', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                scrollToBottom() {
                    const container = this.$refs.messages;
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                },
                getProfilePic(username) {
                    const user = this.users.find(u => u.username === username);
                    return user?.profilePic || this.profilePic || 'https://via.placeholder.com/150';
                },
                
                // Profil fotoğrafı yükleme
                triggerProfilePicUpload() {
                    document.getElementById('profile-pic-upload').click();
                },
                handleProfilePicChange(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.match('image.*')) {
                        this.error = "Lütfen bir resim dosyası seçin";
                        return;
                    }
                    
                    if (file.size > 2 * 1024 * 1024) { // 2MB limit
                        this.error = "Profil fotoğrafı 2MB'tan büyük olamaz";
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.profilePic = e.target.result;
                        this.error = '';
                    };
                    reader.readAsDataURL(file);
                },
                
                // Giriş işlemleri
                login() {
                    if (!this.username) {
                        this.error = "Lütfen bir kullanıcı adı girin";
                        return;
                    }
                    
                    this.loading = true;
                    this.error = '';
                    
                    // PeerJS bağlantısını oluştur
                    this.peer = new Peer(this.generatePeerId(this.username));
                    
                    this.peer.on('open', () => {
                        this.screen = 'chat';
                        this.loading = false;
                    });
                    
                    this.peer.on('error', (err) => {
                        this.loading = false;
                        this.error = `Hata: ${err.type}`;
                        
                        if (err.type === 'unavailable-id') {
                            this.error = "Bu kullanıcı adı zaten alınmış";
                        }
                    });
                    
                    this.peer.on('connection', (conn) => {
                        this.handleConnection(conn);
                    });
                    
                    this.peer.on('disconnected', () => {
                        setTimeout(() => {
                            if (!this.peer.destroyed) {
                                this.peer.reconnect();
                            }
                        }, 1000);
                    });
                },
                
                // Bağlantı yönetimi
                handleConnection(conn) {
                    conn.on('open', () => {
                        // Kullanıcıyı listeye ekle
                        const existingUser = this.users.find(u => u.peerId === conn.peer);
                        if (!existingUser) {
                            this.users.push({
                                peerId: conn.peer,
                                username: conn.metadata?.username || 'Bilinmeyen',
                                profilePic: conn.metadata?.profilePic || null,
                                online: true,
                                conn: conn
                            });
                        } else {
                            existingUser.online = true;
                            existingUser.conn = conn;
                        }
                        
                        // Profil bilgilerini paylaş
                        conn.send({
                            type: 'profile',
                            username: this.username,
                            profilePic: this.profilePic
                        });
                        
                        // Aktif sohbet yoksa bu kullanıcıyı seç
                        if (!this.activeUser) {
                            this.activeUser = conn.peer;
                        }
                    });
                    
                    conn.on('data', (data) => {
                        if (data.type === 'message') {
                            this.messages.push(data.message);
                        } 
                        else if (data.type === 'typing') {
                            this.$set(this.typingUsers, conn.peer, data.isTyping);
                        } 
                        else if (data.type === 'profile') {
                            const user = this.users.find(u => u.peerId === conn.peer);
                            if (user) {
                                user.username = data.username;
                                user.profilePic = data.profilePic;
                            }
                        }
                        else if (data.type === 'file') {
                            this.handleFileTransfer(data);
                        }
                    });
                    
                    conn.on('close', () => {
                        const user = this.users.find(u => u.peerId === conn.peer);
                        if (user) {
                            user.online = false;
                            user.conn = null;
                        }
                    });
                    
                    conn.on('error', (err) => {
                        console.error("Bağlantı hatası:", err);
                        const user = this.users.find(u => u.peerId === conn.peer);
                        if (user) {
                            user.online = false;
                            user.conn = null;
                        }
                    });
                },
                
                // Kullanıcı bağlantısı
                connectToUser() {
                    if (!this.newUser || this.newUser === this.username) {
                        this.connectionError = "Geçersiz kullanıcı adı";
                        return;
                    }
                    
                    const peerId = this.generatePeerId(this.newUser);
                    
                    // Zaten bağlı mı kontrol et
                    if (this.users.some(u => u.peerId === peerId && u.online)) {
                        this.activeUser = peerId;
                        this.newUser = '';
                        this.connectionError = '';
                        return;
                    }
                    
                    this.connectionError = '';
                    
                    const conn = this.peer.connect(peerId, {
                        metadata: {
                            username: this.username,
                            profilePic: this.profilePic
                        },
                        reliable: true
                    });
                    
                    this.handleConnection(conn);
                    
                    // Kullanıcıyı listeye ekle (henüz bağlı değil)
                    if (!this.users.some(u => u.peerId === peerId)) {
                        this.users.push({
                            peerId: peerId,
                            username: this.newUser,
                            profilePic: null,
                            online: false,
                            conn: null
                        });
                    }
                    
                    this.activeUser = peerId;
                    this.newUser = '';
                },
                
                // Mesaj gönderme
                sendMessage() {
                    if (!this.message.trim() || !this.activeUser) return;
                    
                    const user = this.users.find(u => u.peerId === this.activeUser);
                    if (!user || !user.conn) return;
                    
                    const message = {
                        type: 'text',
                        sender: this.username,
                        receiver: user.username,
                        content: this.message,
                        timestamp: Date.now()
                    };
                    
                    this.messages.push(message);
                    
                    try {
                        user.conn.send({
                            type: 'message',
                            message: message
                        });
                    } catch (err) {
                        console.error("Mesaj gönderme hatası:", err);
                    }
                    
                    this.message = '';
                    this.sendTyping(false);
                },
                
                // Yazma durumu
                handleTyping() {
                    if (!this.activeUser) return;
                    
                    // Yazma durumunu gönder
                    this.sendTyping(true);
                    
                    // Önceki zaman aşımını temizle
                    if (this.typingTimeout) clearTimeout(this.typingTimeout);
                    
                    // 2 saniye sonra yazmayı durdur
                    this.typingTimeout = setTimeout(() => {
                        this.sendTyping(false);
                    }, 2000);
                },
                
                sendTyping(isTyping) {
                    const user = this.users.find(u => u.peerId === this.activeUser);
                    if (!user || !user.conn) return;
                    
                    try {
                        user.conn.send({
                            type: 'typing',
                            isTyping: isTyping
                        });
                    } catch (err) {
                        console.error("Yazma durumu gönderme hatası:", err);
                    }
                },
                
                // Dosya işlemleri
                handleFileUpload(e) {
                    this.fileToUpload = e.target.files[0];
                    if (!this.fileToUpload) return;
                    
                    if (this.fileToUpload.size > MAX_FILE_SIZE) {
                        this.connectionError = `Dosya boyutu 50MB'tan büyük olamaz (${this.formatFileSize(this.fileToUpload.size)})`;
                        this.fileToUpload = null;
                        return;
                    }
                    
                    this.sendFile(this.fileToUpload);
                    e.target.value = ''; // Girişi sıfırla
                },
                
                sendFile(file) {
                    if (!this.activeUser) {
                        this.connectionError = "Dosya göndermek için bir kullanıcı seçin";
                        return;
                    }
                    
                    const user = this.users.find(u => u.peerId === this.activeUser);
                    if (!user || !user.conn) {
                        this.connectionError = "Kullanıcı bağlı değil";
                        return;
                    }
                    
                    this.uploading = true;
                    this.uploadProgress = 0;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const fileData = e.target.result;
                        const fileType = file.type.startsWith('image/') ? 'image' : 
                                         file.type.startsWith('video/') ? 'video' : 'file';
                        
                        const fileMessage = {
                            type: fileType,
                            sender: this.username,
                            receiver: user.username,
                            fileName: file.name,
                            fileSize: file.size,
                            content: fileData,
                            timestamp: Date.now()
                        };
                        
                        // Önizleme için mesaj listesine ekle
                        this.messages.push(fileMessage);
                        
                        // Dosyayı parçalara ayır ve gönder
                        const CHUNK_SIZE = 64 * 1024; // 64KB
                        const totalChunks = Math.ceil(fileData.length / CHUNK_SIZE);
                        let chunksSent = 0;
                        
                        const sendNextChunk = () => {
                            const start = chunksSent * CHUNK_SIZE;
                            const end = Math.min(start + CHUNK_SIZE, fileData.length);
                            const chunk = fileData.slice(start, end);
                            
                            try {
                                user.conn.send({
                                    type: 'file',
                                    message: fileMessage,
                                    chunk: chunk,
                                    chunkIndex: chunksSent,
                                    totalChunks: totalChunks
                                });
                                
                                chunksSent++;
                                this.uploadProgress = Math.floor((chunksSent / totalChunks) * 100);
                                
                                if (chunksSent < totalChunks) {
                                    setTimeout(sendNextChunk, 0);
                                } else {
                                    this.uploading = false;
                                }
                            } catch (err) {
                                console.error("Dosya gönderme hatası:", err);
                                this.uploading = false;
                                this.connectionError = "Dosya gönderilemedi";
                            }
                        };
                        
                        sendNextChunk();
                    };
                    
                    if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsBinaryString(file);
                    }
                },
                
                handleFileTransfer(data) {
                    // Dosya parçalarını birleştir
                    if (!this.fileChunks) this.fileChunks = {};
                    
                    const fileKey = `${data.message.sender}-${data.message.timestamp}`;
                    
                    if (!this.fileChunks[fileKey]) {
                        this.fileChunks[fileKey] = {
                            received: 0,
                            total: data.totalChunks,
                            chunks: new Array(data.totalChunks),
                            message: data.message
                        };
                    }
                    
                    this.fileChunks[fileKey].chunks[data.chunkIndex] = data.chunk;
                    this.fileChunks[fileKey].received++;
                    
                    // Tüm parçalar alındı mı kontrol et
                    if (this.fileChunks[fileKey].received === data.totalChunks) {
                        const completeData = this.fileChunks[fileKey].chunks.join('');
                        const completeMessage = this.fileChunks[fileKey].message;
                        completeMessage.content = completeData;
                        
                        this.messages.push(completeMessage);
                        delete this.fileChunks[fileKey];
                    }
                },
                
                downloadFile(message) {
                    let blob;
                    
                    if (message.type === 'image' || message.type === 'video') {
                        // Data URL'den blob oluştur
                        const byteString = atob(message.content.split(',')[1]);
                        const mimeString = message.content.split(',')[0].split(':')[1].split(';')[0];
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        
                        blob = new Blob([ab], { type: mimeString });
                    } else {
                        // Binary dosyalar için
                        const byteCharacters = message.content;
                        const byteNumbers = new Array(byteCharacters.length);
                        
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        
                        const byteArray = new Uint8Array(byteNumbers);
                        blob = new Blob([byteArray], { type: 'application/octet-stream' });
                    }
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = message.fileName || 'dosya';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 0);
                },
                
                showFullscreen(mediaSrc) {
                    this.fullscreenMedia = mediaSrc;
                    this.fullscreenMediaType = mediaSrc.startsWith('data:image') ? 'image' : 'video';
                },
                
                // Kullanıcı seçimi
                selectUser(peerId) {
                    this.activeUser = peerId;
                    this.connectionError = '';
                },
                
                // Bağlantıyı kes
                disconnect() {
                    if (this.peer) {
                        this.peer.destroy();
                    }
                    this.screen = 'login';
                    this.users = [];
                    this.activeUser = null;
                }
            }
        });
    </script>
</body>
</html>
