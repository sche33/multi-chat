<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ðŸ’¬ Tox-Style Chat</title>

  <!-- Material Icons & Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>

  <style>
    /* ----------------- Genel Stil ----------------- */
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:"Red Hat Display",sans-serif;
      background:#f5f5f5;
      color:#333;
      height:100vh;
      display:flex;
    }
    /* ------------- Sol Panel (KullanÄ±cÄ± & ArkadaÅŸ) ------------- */
    #sidebar {
      width:280px;
      background:#fff;
      border-right:1px solid #ddd;
      display:flex;
      flex-direction:column;
      padding:16px;
    }
    #profile {
      text-align:center;
      margin-bottom:24px;
    }
    #profile-img {
      width:80px; height:80px;
      border-radius:50%;
      border:2px solid #888;
      object-fit:cover;
      cursor:pointer;
    }
    #profile input[type=file] { display:none; }
    #username { width:100%; padding:8px; margin-top:8px; border:1px solid #ccc; border-radius:4px; }
    #saveProfile { margin-top:8px; width:100%; }

    #addFriend {
      margin-bottom:16px;
    }
    #addFriend input {
      width: calc(100% - 48px);
      padding:6px;
      border:1px solid #ccc;
      border-radius:4px;
    }
    #addFriend button {
      width:40px;
      height:36px;
      margin-left:4px;
      vertical-align:top;
    }
    #friendsList {
      flex:1;
      overflow-y:auto;
      list-style:none;
    }
    #friendsList li {
      padding:8px;
      border-bottom:1px solid #eee;
      cursor:pointer;
    }
    #friendsList li.active { background:#e0f7fa; }
    /* --------------- SaÄŸ Panel (Sohbet) --------------- */
    #chatPanel {
      flex:1;
      display:flex;
      flex-direction:column;
    }
    #tabs {
      display:flex;
      background:#fff;
      border-bottom:1px solid #ddd;
    }
    #tabs button {
      flex:1;
      padding:12px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:600;
    }
    #tabs button.active {
      border-bottom:3px solid #0288d1;
      color:#0288d1;
    }
    #chatHeader {
      padding:12px;
      background:#fafafa;
      border-bottom:1px solid #eee;
      font-weight:500;
    }
    .chatWindow {
      flex:1;
      padding:16px;
      background:#e8f5e9;
      overflow-y:auto;
    }
    .chatWindow.private { background:#fff3e0; }
    .message {
      margin:8px 0;
      max-width:70%;
      padding:8px 12px;
      border-radius:16px;
      position:relative;
      word-wrap:break-word;
    }
    .message.me {
      background:#0288d1;
      color:#fff;
      margin-left:auto;
    }
    .message.them {
      background:#e0e0e0;
      color:#000;
      margin-right:auto;
    }
    .message .meta {
      font-size:10px;
      opacity:0.7;
      position:absolute;
      bottom:-14px;
      right:8px;
    }
    #inputArea {
      display:flex;
      padding:12px;
      background:#fff;
      border-top:1px solid #ddd;
    }
    #inputArea input[type=text] {
      flex:1;
      padding:10px;
      border:1px solid #ccc;
      border-radius:4px;
    }
    #inputArea input[type=file] { display:none; }
    #inputArea button {
      margin-left:8px;
      padding:0 12px;
      border:none;
      background:#0288d1;
      color:#fff;
      border-radius:4px;
      cursor:pointer;
    }
    #inputArea .attach-btn {
      background:transparent;
      color:#555;
    }
  </style>
</head>
<body>

  <!-- =========== Sol Panel =========== -->
  <div id="sidebar">
    <div id="profile">
      <label for="profile-input">
        <img id="profile-img" src="" title="Profil fotoÄŸrafÄ±nÄ± deÄŸiÅŸtirmek iÃ§in tÄ±kla"/>
      </label>
      <input type="file" id="profile-input" accept="image/*"/>
      <input type="text" id="username" placeholder="KullanÄ±cÄ± adÄ±n"/>
      <button id="saveProfile">Kaydet</button>
    </div>

    <!-- ArkadaÅŸ Ekle -->
    <div id="addFriend">
      <input type="text" id="friendIdInput" placeholder="ArkadaÅŸ IDâ€™si"/>
      <button id="addFriendBtn" title="Ekle"><span class="material-icons">person_add</span></button>
    </div>

    <!-- ArkadaÅŸ Listesi -->
    <ul id="friendsList"></ul>
  </div>

  <!-- =========== SaÄŸ Panel =========== -->
  <div id="chatPanel">
    <!-- Sekmeler -->
    <div id="tabs">
      <button data-tab="general" class="active">Genel</button>
      <button data-tab="private">Ã–zel</button>
    </div>

    <!-- BaÅŸlÄ±k -->
    <div id="chatHeader">Genel Sohbet</div>

    <!-- Genel Sohbet Penceresi -->
    <div id="generalWindow" class="chatWindow"></div>
    <!-- Ã–zel Sohbet Penceresi -->
    <div id="privateWindow" class="chatWindow private" style="display:none;"></div>

    <!-- Mesaj GiriÅŸ AlanÄ± -->
    <div id="inputArea">
      <button class="attach-btn" id="attachBtn" title="Dosya Ekle"><span class="material-icons">attach_file</span></button>
      <input type="file" id="fileInput" accept="image/*,video/*,.pdf,.doc,.zip"/>
      <input type="text" id="messageInput" placeholder="Mesaj yaz..."/>
      <button id="sendBtn">GÃ¶nder</button>
    </div>
  </div>

<script>
(function(){
  // -------- Firebase BaÅŸlatma --------
  const firebaseConfig = {
    apiKey: "AIzaSyD30unp7ap6R6sJoU8EEKRkqlyK-dPjuqM",
    authDomain: "genelchatprojesi.firebaseapp.com",
    databaseURL: "https://genelchatprojesi-default-rtdb.firebaseio.com",
    projectId: "genelchatprojesi",
    storageBucket: "genelchatprojesi.appspot.com",
    messagingSenderId: "751359781972",
    appId: "1:751359781972:web:da28a4695f9571736191c1"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // -------- DOM ElemanlarÄ± --------
  const profileImg   = document.getElementById('profile-img');
  const profileIn    = document.getElementById('profile-input');
  const usernameIn   = document.getElementById('username');
  const saveProfile  = document.getElementById('saveProfile');
  const friendIn     = document.getElementById('friendIdInput');
  const addFriendBtn = document.getElementById('addFriendBtn');
  const friendsList  = document.getElementById('friendsList');
  const tabs         = document.querySelectorAll('#tabs button');
  const header       = document.getElementById('chatHeader');
  const genWin       = document.getElementById('generalWindow');
  const privWin      = document.getElementById('privateWindow');
  const attachBtn    = document.getElementById('attachBtn');
  const fileInput    = document.getElementById('fileInput');
  const msgInput     = document.getElementById('messageInput');
  const sendBtn      = document.getElementById('sendBtn');

  // -------- LocalStorageâ€™dan Verileri Al --------
  let userId   = localStorage.getItem('userId');
  let username = localStorage.getItem('username');
  let profilePic = localStorage.getItem('profilePic');
  let friends  = JSON.parse(localStorage.getItem('friends')||'[]');

  // -------- Otomatik User ID OluÅŸtur --------
  if(!userId){
    userId = (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).substr(2,9));
    localStorage.setItem('userId', userId);
  }
  usernameIn.value = username || '';
  if(profilePic) profileImg.src = profilePic;

  // -------- Profil Kaydetme --------
  saveProfile.onclick = () => {
    username = usernameIn.value.trim()||username||'Anonim';
    localStorage.setItem('username', username);
    alert('Profil gÃ¼ncellendi!');
  };
  profileImg.onclick = () => profileIn.click();
  profileIn.onchange = e => {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      profilePic = ev.target.result;
      profileImg.src  = profilePic;
      localStorage.setItem('profilePic', profilePic);
    };
    r.readAsDataURL(f);
  };

  // -------- ArkadaÅŸ Listesi --------
  function renderFriends(){
    friendsList.innerHTML = '';
    friends.forEach(fid=>{
      const li = document.createElement('li');
      li.textContent = fid;
      li.onclick = ()=>{
        currentTab = 'private';
        switchTab();
        selectFriend(fid);
      };
      friendsList.appendChild(li);
    });
  }
  addFriendBtn.onclick = ()=>{
    const fid = friendIn.value.trim();
    if(!fid||fid===userId) return alert('GeÃ§erli bir ID girin.');
    if(friends.includes(fid)) return alert('Zaten ekli.');
    friends.push(fid);
    localStorage.setItem('friends', JSON.stringify(friends));
    renderFriends();
    friendIn.value = '';
  };
  renderFriends();

  // -------- Sekme GeÃ§iÅŸi --------
  let currentTab = 'general';
  tabs.forEach(btn=>{
    btn.onclick = ()=>{
      currentTab = btn.dataset.tab;
      switchTab();
    };
  });
  function switchTab(){
    tabs.forEach(b=>b.classList.toggle('active', b.dataset.tab===currentTab));
    header.textContent = currentTab==='general' ? 'Genel Sohbet' : 'Ã–zel Sohbet';
    genWin.style.display = currentTab==='general' ? 'flex' : 'none';
    privWin.style.display= currentTab==='private'? 'flex' : 'none';
  }

  // -------- Mesaj GÃ¶nderme --------
  attachBtn.onclick = ()=> fileInput.click();
  sendBtn.onclick = sendMessage;
  fileInput.onchange = ()=> sendMessage(); // dosya yÃ¼klendiÄŸinde de gÃ¶nder

  function sendMessage(){
    const txt = msgInput.value.trim();
    const file = fileInput.files[0];
    if(!txt && !file) return;

    const now = Date.now();
    const baseRef = currentTab==='general'
      ? db.ref('chats/general')
      : db.ref('chats/private/' + sortedChatId);

    // Ã¶nce dosya yÃ¼kle, sonra mesajÄ± DBâ€™ye it:
    if(file){
      const ext = file.name.split('.').pop();
      const path = `${currentTab}/${userId}_${now}.${ext}`;
      const uploadTask = storage.ref(path).put(file);
      uploadTask.on('state_changed',null,console.error, ()=>{
        uploadTask.snapshot.ref.getDownloadURL().then(url=>{
          pushMsg(baseRef, txt, url, file.type);
        });
      });
    } else {
      pushMsg(baseRef, txt, null, null);
    }
    msgInput.value=''; fileInput.value=null;
  }

  function pushMsg(ref, text, fileUrl, fileType){
    ref.push({
      senderId: userId,
      senderName: username||'Anonim',
      senderPic: profilePic||'',
      text: text||'',
      fileUrl:fileUrl||'',
      fileType:fileType||'',
      timestamp: Date.now()
    });
  }

  // -------- Genel Sohbet Dinleyici --------
  db.ref('chats/general').on('child_added',snap=>{
    renderMessage(snap.val(), genWin);
  });

  // -------- Ã–zel Sohbet Dinleme --------
  let sortedChatId = '';
  function selectFriend(fid){
    sortedChatId = [userId, fid].sort().join('_');
    privWin.innerHTML='';
    // Ã¶nceki dinleyiciyi kapat:
    db.ref('chats/private').off();
    // yeni dinleyici
    db.ref('chats/private/'+sortedChatId)
      .on('child_added',snap=> renderMessage(snap.val(), privWin));
  }

  // -------- MesajÄ± DOMâ€™a Ekle --------
  function renderMessage(msg, container){
    const div = document.createElement('div');
    div.className = 'message ' + (msg.senderId===userId?'me':'them');
    // Profil resmi
    if(msg.senderPic){
      const img = document.createElement('img');
      img.src=msg.senderPic;
      img.style.width='24px';
      img.style.height='24px';
      img.style.borderRadius='50%';
      img.style.verticalAlign='middle';
      img.style.marginRight='6px';
      div.appendChild(img);
    }
    // Metin
    const span = document.createElement('span');
    span.innerText = msg.text;
    div.appendChild(span);
    // Dosya
    if(msg.fileUrl){
      const br = document.createElement('br');
      div.appendChild(br);
      if(msg.fileType.startsWith('image')){
        const i = document.createElement('img');
        i.src=msg.fileUrl;
        i.style.maxWidth='200px';
        div.appendChild(i);
      } else if(msg.fileType.startsWith('video')){
        const v = document.createElement('video');
        v.src=msg.fileUrl; v.controls=true; v.style.maxWidth='200px';
        div.appendChild(v);
      } else {
        const a = document.createElement('a');
        a.href=msg.fileUrl; a.target='_blank';
        a.innerText='DosyayÄ± Ä°ndir';
        div.appendChild(a);
      }
    }
    // Zaman
    const meta = document.createElement('div');
    meta.className='meta';
    meta.innerText = new Date(msg.timestamp).toLocaleTimeString();
    div.appendChild(meta);

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  // Ä°lk sekme ayarÄ±
  switchTab();
})();
</script>

</body>
</html>
