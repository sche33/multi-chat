<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basit Chat Uygulaması</title>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .login-box, .chat-box {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .chat-container {
            display: flex;
            gap: 20px;
        }
        
        .user-list {
            width: 250px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        .user-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .user-item:hover {
            background-color: #f9f9f9;
        }
        
        .user-item.active {
            background-color: #e9f5ff;
        }
        
        .chat-area {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 500px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 70%;
        }
        
        .message.incoming {
            background-color: #f1f1f1;
            align-self: flex-start;
        }
        
        .message.outgoing {
            background-color: #4CAF50;
            color: white;
            align-self: flex-end;
        }
        
        .message-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .send-btn {
            width: auto;
            padding: 10px 20px;
        }
        
        .rank-icon {
            width: 16px;
            height: 16px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .error {
            color: red;
            margin-top: 10px;
            text-align: center;
        }
        
        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .online {
            background-color: #4CAF50;
        }
        
        .offline {
            background-color: #ccc;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Giriş Ekranı -->
        <div v-if="screen === 'login'" class="container">
            <div class="login-box">
                <h1>Giriş Yap</h1>
                <input type="text" v-model="username" placeholder="Kullanıcı Adı">
                <input type="password" v-model="password" placeholder="Şifre">
                <button @click="login">Giriş Yap</button>
                <p class="error">{{ error }}</p>
            </div>
        </div>
        
        <!-- Chat Ekranı -->
        <div v-if="screen === 'chat'" class="container">
            <h1>Chat Uygulaması</h1>
            
            <div class="chat-container">
                <!-- Kullanıcı Listesi -->
                <div class="user-list">
                    <h3>Kullanıcılar</h3>
                    <div v-for="user in allUsers" 
                         :key="user.username" 
                         class="user-item"
                         :class="{ active: selectedUser && selectedUser.username === user.username }"
                         @click="selectUser(user)">
                        {{ user.username }}
                        <img v-if="getRole(user.role).icon" :src="getRole(user.role).icon" class="rank-icon">
                        <span class="online-status" :class="isUserOnline(user.username) ? 'online' : 'offline'"></span>
                    </div>
                </div>
                
                <!-- Chat Alanı -->
                <div class="chat-area" v-if="selectedUser">
                    <div class="messages">
                        <div v-for="(message, index) in filteredMessages" 
                             :key="index" 
                             class="message"
                             :class="message.sender === currentUser.username ? 'outgoing' : 'incoming'">
                            <strong>{{ message.sender }}</strong>
                            <p>{{ message.text }}</p>
                            <small>{{ formatTime(message.timestamp) }}</small>
                        </div>
                    </div>
                    
                    <div class="message-input-area">
                        <input type="text" 
                               v-model="newMessage" 
                               class="message-input" 
                               placeholder="Mesaj yaz..."
                               @keyup.enter="sendMessage">
                        <button @click="sendMessage" class="send-btn">Gönder</button>
                    </div>
                </div>
                
                <div v-else class="chat-area" style="text-align: center; padding: 50px;">
                    <p>Bir kullanıcı seçerek sohbete başlayın</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const appPrefix = "simple-chat-";
        const ADMIN_PASSWORD = "QSjL4wsz3ZexMvw2pyheHethZFmKyr7JAFVH8WN5wHW4Gvc8";
        const PEERJS_CONFIG = {
            host: 'peerjs-server-1.herokuapp.com',
            secure: true,
            port: 443
        };

        // Rol tanımları
        const roles = [
            { name: "Yeni Üye", icon: "https://i.imgur.com/JzT9Z7n.png", messageReq: 0 },
            { name: "Üye", icon: "https://i.imgur.com/4Q7XZ9L.png", messageReq: 100 },
            { name: "Kıdemli Üye", icon: "https://i.imgur.com/8XZ9L4Q.png", messageReq: 300 },
            { name: "Uzman", icon: "https://i.imgur.com/Z9L4Q8X.png", messageReq: 600 },
            { name: "Kıdemli Uzman", icon: "https://i.imgur.com/L4Q8XZ9.png", messageReq: 1000 },
            { name: "Çavuş", icon: "https://i.imgur.com/Q8XZ9L4.png", messageReq: 1500 },
            { name: "Kıdemli Çavuş", icon: "https://i.imgur.com/XZ9L4Q8.png", messageReq: 2100 },
            { name: "Astsubay", icon: "https://i.imgur.com/9L4Q8XZ.png", messageReq: 2800 },
            { name: "Kıdemli Astsubay", icon: "https://i.imgur.com/4Q8XZ9L.png", messageReq: 3600 },
            { name: "Subay", icon: "https://i.imgur.com/8XZ9L4Q.png", messageReq: 4500 },
            { name: "Kıdemli Subay", icon: "https://i.imgur.com/Z9L4Q8X.png", messageReq: 5500 },
            { name: "Komutan", icon: "https://i.imgur.com/L4Q8XZ9.png", messageReq: 6600 },
            { name: "Mareşal", icon: "https://i.imgur.com/Q8XZ9L4.png", messageReq: 7800 }
        ];

        const app = new Vue({
            el: "#app",
            data: {
                screen: "login",
                username: "",
                password: "",
                error: "",
                
                // Chat verileri
                currentUser: null,
                allUsers: [],
                selectedUser: null,
                messages: [],
                newMessage: "",
                
                // PeerJS
                peer: null,
                connections: {},
                peerIds: []
            },
            computed: {
                filteredMessages() {
                    if (!this.selectedUser) return [];
                    
                    return this.messages.filter(msg => 
                        (msg.sender === this.currentUser.username && msg.receiver === this.selectedUser.username) ||
                        (msg.sender === this.selectedUser.username && msg.receiver === this.currentUser.username)
                    );
                }
            },
            methods: {
                // Giriş işlemleri
                login() {
                    if (!this.username || !this.password) {
                        this.error = "Kullanıcı adı ve şifre gereklidir";
                        return;
                    }
                    
                    // Admin giriş kontrolü
                    if (this.username === "admin" && this.password === ADMIN_PASSWORD) {
                        this.initUser({
                            username: "admin",
                            password: ADMIN_PASSWORD,
                            role: 12 // Mareşal
                        });
                        return;
                    }
                    
                    // Kullanıcı kontrolü
                    const users = JSON.parse(localStorage.getItem("users") || "[]");
                    const user = users.find(u => u.username === this.username && u.password === this.password);
                    
                    if (user) {
                        this.initUser(user);
                    } else {
                        this.error = "Geçersiz kullanıcı adı veya şifre";
                    }
                },
                
                initUser(user) {
                    this.currentUser = {
                        ...user,
                        sessionId: this.generateSessionId(),
                        messageCount: user.messageCount || 0
                    };
                    
                    // Kullanıcıyı güncelle veya ekle
                    const users = JSON.parse(localStorage.getItem("users") || "[]");
                    const existingUserIndex = users.findIndex(u => u.username === user.username);
                    
                    if (existingUserIndex >= 0) {
                        users[existingUserIndex] = this.currentUser;
                    } else {
                        users.push(this.currentUser);
                    }
                    
                    localStorage.setItem("users", JSON.stringify(users));
                    this.loadUsers();
                    this.screen = "chat";
                    this.initPeer();
                },
                
                // Kullanıcı yönetimi
                loadUsers() {
                    const users = JSON.parse(localStorage.getItem("users") || "[]");
                    
                    // Admin kullanıcısını ekle (eğer yoksa)
                    if (!users.some(u => u.username === "admin")) {
                        users.push({
                            username: "admin",
                            password: ADMIN_PASSWORD,
                            role: 12 // Mareşal
                        });
                        localStorage.setItem("users", JSON.stringify(users));
                    }
                    
                    this.allUsers = users.filter(u => u.username !== this.currentUser.username);
                },
                
                isUserOnline(username) {
                    return this.peerIds.includes(this.getPeerId(username));
                },
                
                // Mesaj işlemleri
                selectUser(user) {
                    this.selectedUser = user;
                },
                
                sendMessage() {
                    if (!this.newMessage.trim() || !this.selectedUser) return;
                    
                    const message = {
                        sender: this.currentUser.username,
                        receiver: this.selectedUser.username,
                        text: this.newMessage,
                        timestamp: Date.now()
                    };
                    
                    this.messages.push(message);
                    
                    // Diğer kullanıcıya gönder
                    const peerId = this.getPeerId(this.selectedUser.username);
                    if (this.connections[peerId]) {
                        this.connections[peerId].send({
                            type: "message",
                            message
                        });
                    }
                    
                    // Mesaj sayısını güncelle
                    this.currentUser.messageCount++;
                    this.updateUser(this.currentUser);
                    
                    // Rol kontrolü
                    this.checkRank();
                    
                    this.newMessage = "";
                },
                
                receiveMessage(message) {
                    this.messages.push(message);
                },
                
                // Rol yönetimi
                getRole(roleIndex) {
                    return roles[roleIndex] || roles[0];
                },
                
                checkRank() {
                    for (let i = roles.length - 1; i >= 0; i--) {
                        if (this.currentUser.messageCount >= roles[i].messageReq && this.currentUser.role < i) {
                            this.currentUser.role = i;
                            this.updateUser(this.currentUser);
                            
                            // Tüm bağlantılara yeni rol bilgisini gönder
                            Object.values(this.connections).forEach(conn => {
                                conn.send({
                                    type: "userUpdate",
                                    user: this.currentUser
                                });
                            });
                            break;
                        }
                    }
                },
                
                updateUser(user) {
                    const users = JSON.parse(localStorage.getItem("users") || "[]");
                    const index = users.findIndex(u => u.username === user.username);
                    
                    if (index >= 0) {
                        users[index] = user;
                        localStorage.setItem("users", JSON.stringify(users));
                    }
                },
                
                // PeerJS işlemleri
                initPeer() {
                    this.peer = new Peer(this.getPeerId(this.currentUser.username), PEERJS_CONFIG);
                    
                    this.peer.on("open", () => {
                        console.log("PeerJS bağlantısı kuruldu");
                    });
                    
                    this.peer.on("connection", (conn) => {
                        this.setupConnection(conn);
                        
                        conn.on("open", () => {
                            this.addConnection(conn);
                            
                            // Kullanıcı bilgilerini gönder
                            conn.send({
                                type: "userUpdate",
                                user: this.currentUser
                            });
                        });
                    });
                    
                    this.peer.on("error", (err) => {
                        console.error("PeerJS hatası:", err);
                    });
                },
                
                connectToUser(username) {
                    const peerId = this.getPeerId(username);
                    
                    if (!this.connections[peerId] && peerId !== this.peer.id) {
                        const conn = this.peer.connect(peerId);
                        this.setupConnection(conn);
                        
                        conn.on("open", () => {
                            this.addConnection(conn);
                        });
                    }
                },
                
                setupConnection(conn) {
                    conn.on("data", (data) => {
                        if (data.type === "message") {
                            this.receiveMessage(data.message);
                        } else if (data.type === "userUpdate") {
                            // Kullanıcı bilgisi güncellendi
                            const users = JSON.parse(localStorage.getItem("users") || "[]");
                            const index = users.findIndex(u => u.username === data.user.username);
                            
                            if (index >= 0) {
                                users[index] = data.user;
                                localStorage.setItem("users", JSON.stringify(users));
                                this.loadUsers();
                            }
                        }
                    });
                    
                    conn.on("close", () => {
                        this.removeConnection(conn);
                    });
                    
                    conn.on("error", (err) => {
                        console.error("Bağlantı hatası:", err);
                        this.removeConnection(conn);
                    });
                },
                
                addConnection(conn) {
                    this.connections[conn.peer] = conn;
                    this.updatePeerIds();
                },
                
                removeConnection(conn) {
                    delete this.connections[conn.peer];
                    this.updatePeerIds();
                },
                
                updatePeerIds() {
                    this.peerIds = Object.keys(this.connections);
                },
                
                getPeerId(username) {
                    return appPrefix + username;
                },
                
                // Yardımcı fonksiyonlar
                generateSessionId() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                },
                
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            },
            mounted() {
                // Sayfa yüklendiğinde admin kullanıcısını ekle (eğer yoksa)
                const users = JSON.parse(localStorage.getItem("users") || "[]");
                if (!users.some(u => u.username === "admin")) {
                    users.push({
                        username: "admin",
                        password: ADMIN_PASSWORD,
                        role: 12 // Mareşal
                    });
                    localStorage.setItem("users", JSON.stringify(users));
                }
            }
        });
    </script>
</body>
</html>
