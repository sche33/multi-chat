<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat Uygulaması</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family: Arial, sans-serif; }
    body, html { height:100%; }
    #app { display:flex; height:100vh; }
    /* Sol Panel */
    #leftPanel { width:300px; background:#fafafa; border-right:1px solid #ddd; display:flex; flex-direction:column; }
    #userInfo { display:flex; align-items:center; padding:10px; background:#f0f0f0; }
    #myPhoto { width:50px; height:50px; border:2px solid #888; border-radius:50%; background:#ccc; cursor:pointer; object-fit:cover; }
    #userInfo input { margin-left:10px; flex:1; padding:6px; }
    #userInfo button { margin-left:5px; }
    #addFriend { padding:10px; border-bottom:1px solid #ddd; }
    #addFriend input { width:calc(100% - 80px); padding:6px; }
    #addFriend button { width:60px; margin-left:5px; }
    #friendsList { flex:1; overflow-y:auto; list-style:none; }
    #friendsList li { padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
    #friendsList li:hover { background:#eef; }
    /* Sağ Panel */
    #chat { flex:1; display:flex; flex-direction:column; }
    #chatHeader { padding:10px; background:#f0f0f0; border-bottom:1px solid #ddd; }
    #messages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; background:white; }
    .message { margin-bottom:8px; max-width:70%; padding:8px; border-radius:10px; word-wrap:break-word; }
    .from-me { background:#dcf8c6; align-self:flex-end; }
    .from-them { background:#f1f0f0; align-self:flex-start; }
    #inputArea { display:flex; padding:10px; border-top:1px solid #ddd; }
    #messageInput { flex:1; padding:8px; }
    #sendBtn { margin-left:5px; padding:8px 12px; }
  </style>
  <!-- Firebase SDK'ları CDN -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
<div id="app">
  <!-- Sol Panel: Kullanıcı ve Arkadaş Listesi -->
  <div id="leftPanel">
    <div id="userInfo">
      <img id="myPhoto" title="Profil resminizi yükleyin" alt="Profil">
      <input type="text" id="usernameInput" placeholder="Kullanıcı adınız">
      <button id="setNameBtn">Kaydet</button>
    </div>
    <div id="addFriend">
      <input type="text" id="friendIdInput" placeholder="Arkadaş ID'si">
      <button id="addFriendBtn">Ekle</button>
    </div>
    <ul id="friendsList"></ul>
  </div>
  <!-- Sağ Panel: Sohbet -->
  <div id="chat">
    <div id="chatHeader">Arkadaş: <span id="friendName">-</span></div>
    <div id="messages"></div>
    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Mesaj yazın...">
      <button id="sendBtn">Gönder</button>
    </div>
  </div>
</div>

<!-- Gizli dosya seçici: Profil resmi yükleme -->
<input type="file" id="photoInput" accept="image/*" style="display:none">

<script>
  // Firebase başlatma (kendi config bilgilerinizle doldurun)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);

  // Kullanıcı bilgileri (localStorage)
  if (!localStorage.getItem('userId')) {
    // Güvenli UUID oluşturma (HTTPS gerektirir) veya basit rastgele ID
    const id = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substr(2,9));
    localStorage.setItem('userId', id);
  }
  const userId = localStorage.getItem('userId');
  let username = localStorage.getItem('username') || '';
  if (!username) {
    username = prompt("Kullanıcı adınızı girin:");
    if (username) localStorage.setItem('username', username);
  }
  document.getElementById('usernameInput').value = username;

  // Profil resmi yükleme
  const myPhoto = document.getElementById('myPhoto');
  const photoInput = document.getElementById('photoInput');
  // Eğer daha önce yüklenmişse göster
  if (localStorage.getItem('profilePic')) {
    myPhoto.src = localStorage.getItem('profilePic');
  }
  // Fotoğraf tıklayınca dosya seçici aç
  myPhoto.addEventListener('click', () => photoInput.click());
  photoInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      const dataUrl = event.target.result;
      localStorage.setItem('profilePic', dataUrl);
      myPhoto.src = dataUrl;
    };
    reader.readAsDataURL(file);
  });

  // Kullanıcı adı güncelleme
  const setNameBtn = document.getElementById('setNameBtn');
  setNameBtn.addEventListener('click', () => {
    const input = document.getElementById('usernameInput');
    if (input.value.trim()) {
      localStorage.setItem('username', input.value.trim());
      username = input.value.trim();
      alert("Kullanıcı adı güncellendi.");
    }
  });

  // Arkadaş listesi yönetimi
  let friends = JSON.parse(localStorage.getItem('friends') || '[]');
  const friendsListEl = document.getElementById('friendsList');
  function renderFriends() {
    friendsListEl.innerHTML = '';
    friends.forEach(fid => {
      const li = document.createElement('li');
      li.textContent = fid;
      li.addEventListener('click', () => selectFriend(fid));
      friendsListEl.appendChild(li);
    });
  }
  renderFriends();

  document.getElementById('addFriendBtn').addEventListener('click', () => {
    const friendId = document.getElementById('friendIdInput').value.trim();
    if (!friendId) { alert("ID girin."); return; }
    if (friendId === userId) { alert("Kendi ID'niz ile arkadaş ekleyemezsiniz."); return; }
    if (friends.includes(friendId)) { alert("Bu ID zaten listede."); return; }
    friends.push(friendId);
    localStorage.setItem('friends', JSON.stringify(friends));
    renderFriends();
    document.getElementById('friendIdInput').value = '';
  });

  // Sohbet işlemleri
  let currentFriend = null;
  let chatRef = null;
  function getChatId(id1, id2) {
    // Karakter dizisi sıralı birleşim (örn. "a_b")
    return [id1, id2].sort().join('_');
  }
  function selectFriend(friendId) {
    currentFriend = friendId;
    document.getElementById('friendName').textContent = friendId;
    document.getElementById('messages').innerHTML = '';
    // Önceki dinleyiciyi kapat
    if (chatRef) chatRef.off();
    // Yeni dinleyici
    const chatId = getChatId(userId, friendId);
    chatRef = firebase.database().ref('messages/' + chatId);
    chatRef.on('child_added', snapshot => {
      const msg = snapshot.val();
      const msgDiv = document.createElement('div');
      msgDiv.textContent = msg.text;
      msgDiv.classList.add('message');
      if (msg.senderId === userId) {
        msgDiv.classList.add('from-me');
      } else {
        msgDiv.classList.add('from-them');
      }
      document.getElementById('messages').appendChild(msgDiv);
      // Scroll en alta
      const messagesDiv = document.getElementById('messages');
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // Mesaj gönderme
  document.getElementById('sendBtn').addEventListener('click', () => {
    const text = document.getElementById('messageInput').value.trim();
    if (!text || !currentFriend) return;
    const chatId = getChatId(userId, currentFriend);
    firebase.database().ref('messages/' + chatId).push({
      senderId: userId,
      text: text
    });
    document.getElementById('messageInput').value = '';
  });
</script>
</body>
</html>
