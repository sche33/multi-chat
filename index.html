<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Genel + Özel Chat</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f3f3f3; }
    .chat-box { border: 1px solid #ccc; padding: 10px; background: white; height: 200px; overflow-y: scroll; margin-bottom: 10px; }
    input, button, select { padding: 8px; margin-top: 5px; }
    #profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 1px solid #aaa; }
  </style>
</head>
<body>

  <h2>Profil</h2>
  <input type="text" id="username" placeholder="Kullanıcı adınız" />
  <input type="file" id="profileInput" accept="image/*" />
  <br/>
  <img id="profile-pic" src="" alt="Profil Fotoğrafı" />
  
  <h2>Genel Chat</h2>
  <div class="chat-box" id="genelChat"></div>
  <input type="text" id="genelMesaj" placeholder="Genel mesaj yaz..." />
  <button onclick="gonderGenel()">Gönder</button>

  <h2>Özel Chat</h2>
  <select id="hedefKullanici"></select>
  <div class="chat-box" id="ozelChat"></div>
  <input type="text" id="ozelMesaj" placeholder="Özel mesaj yaz..." />
  <button onclick="gonderOzel()">Gönder</button>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    // Firebase yapılandırması
    const firebaseConfig = {
      apiKey: "AIzaSyD30unp7ap6R6sJoU8EEKRkqlyK-dPjuqM",
      authDomain: "genelchatprojesi.firebaseapp.com",
      databaseURL: "https://genelchatprojesi-default-rtdb.firebaseio.com",
      projectId: "genelchatprojesi",
      storageBucket: "genelchatprojesi.appspot.com",
      messagingSenderId: "751359781972",
      appId: "1:751359781972:web:da28a4695f9571736191c1",
      measurementId: "G-NSW2EZQ886"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const usernameInput = document.getElementById("username");
    const profileInput = document.getElementById("profileInput");
    const profilePic = document.getElementById("profile-pic");

    // Profil Fotoğrafı Yükleme
    profileInput.addEventListener("change", () => {
      const reader = new FileReader();
      reader.onload = function(e) {
        profilePic.src = e.target.result;
        localStorage.setItem("profilePic", e.target.result);
      }
      reader.readAsDataURL(profileInput.files[0]);
    });

    // Önceden kayıtlı profil varsa yükle
    window.addEventListener("load", () => {
      const pic = localStorage.getItem("profilePic");
      if (pic) profilePic.src = pic;
    });

    // GENEL MESAJ GÖNDER
    function gonderGenel() {
      const ad = usernameInput.value.trim();
      const mesaj = document.getElementById("genelMesaj").value.trim();
      if (!ad || !mesaj) return;
      db.ref("genel").push({ ad, mesaj });
      document.getElementById("genelMesaj").value = "";
    }

    // GENEL MESAJLARI DİNLE
    db.ref("genel").on("child_added", snap => {
      const { ad, mesaj } = snap.val();
      const box = document.getElementById("genelChat");
      box.innerHTML += `<b>${ad}:</b> ${mesaj}<br>`;
      box.scrollTop = box.scrollHeight;
      if (!kullanicilar.includes(ad)) {
        kullanicilar.push(ad);
        guncelleKullaniciSec();
      }
    });

    let kullanicilar = [];

    function guncelleKullaniciSec() {
      const sec = document.getElementById("hedefKullanici");
      sec.innerHTML = "";
      kullanicilar.forEach(ad => {
        if (ad !== usernameInput.value) {
          const opt = document.createElement("option");
          opt.value = ad;
          opt.textContent = ad;
          sec.appendChild(opt);
        }
      });
    }

    // ÖZEL MESAJ GÖNDER
    function gonderOzel() {
      const gonderen = usernameInput.value.trim();
      const hedef = document.getElementById("hedefKullanici").value;
      const mesaj = document.getElementById("ozelMesaj").value.trim();
      if (!gonderen || !hedef || !mesaj) return;
      const key = `${gonderen}__TO__${hedef}`;
      db.ref("ozel/" + key).push({ gonderen, mesaj });
      document.getElementById("ozelMesaj").value = "";
    }

    // ÖZEL MESAJLARI DİNLE (2 taraflı)
    function dinleOzel() {
      const ad = usernameInput.value.trim();
      if (!ad) return;
      db.ref("ozel").on("child_added", snap => {
        const key = snap.key;
        if (key.includes(ad)) {
          db.ref("ozel/" + key).on("child_added", msgSnap => {
            const { gonderen, mesaj } = msgSnap.val();
            const box = document.getElementById("ozelChat");
            box.innerHTML += `<b>${gonderen}:</b> ${mesaj}<br>`;
            box.scrollTop = box.scrollHeight;
          });
        }
      });
    }

    // Kullanıcı adı girildiğinde özel sohbet dinlemeyi başlat
    usernameInput.addEventListener("change", dinleOzel);
  </script>

</body>
</html>
