<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ðŸ’¬ Tox-Style Chat</title>

  <!-- Material Icons & Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>

  <style>
    /* ----------------- Genel Stil ----------------- */
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:"Red Hat Display",sans-serif;
      background:#f5f5f5;
      color:#333;
      height:100vh;
      display:flex;
    }
    /* ------------- Sol Panel (KullanÄ±cÄ± & ArkadaÅŸ) ------------- */
    #sidebar {
      width:280px;
      background:#fff;
      border-right:1px solid #ddd;
      display:flex;
      flex-direction:column;
      padding:16px;
    }
    #profile {
      text-align:center;
      margin-bottom:24px;
    }
    #profile-img {
      width:80px; height:80px;
      border-radius:50%;
      border:2px solid #888;
      object-fit:cover;
      cursor:pointer;
      background:#eee;
    }
    #profile input[type=file] { display:none; }
    #username { width:100%; padding:8px; margin-top:8px; border:1px solid #ccc; border-radius:4px; }
    #saveProfile { 
      margin-top:8px; 
      width:100%;
      padding:8px;
      background:#0288d1;
      color:white;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    #userIdDisplay {
      margin-top:8px;
      font-size:12px;
      word-break:break-all;
      background:#f5f5f5;
      padding:6px;
      border-radius:4px;
    }
    #copyIdBtn {
      margin-top:4px;
      padding:4px;
      font-size:12px;
      background:#e0e0e0;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }

    #addFriend {
      margin-bottom:16px;
      display:flex;
    }
    #addFriend input {
      flex:1;
      padding:8px;
      border:1px solid #ccc;
      border-radius:4px 0 0 4px;
      border-right:none;
    }
    #addFriend button {
      width:40px;
      height:36px;
      background:#0288d1;
      color:white;
      border:none;
      border-radius:0 4px 4px 0;
      cursor:pointer;
    }
    #friendsList {
      flex:1;
      overflow-y:auto;
      list-style:none;
    }
    #friendsList li {
      padding:12px;
      border-bottom:1px solid #eee;
      cursor:pointer;
      display:flex;
      align-items:center;
    }
    #friendsList li.active { background:#e0f7fa; }
    #friendsList li img {
      width:32px;
      height:32px;
      border-radius:50%;
      margin-right:8px;
      object-fit:cover;
    }
    #friendsList li .friend-name {
      flex:1;
    }
    /* --------------- SaÄŸ Panel (Sohbet) --------------- */
    #chatPanel {
      flex:1;
      display:flex;
      flex-direction:column;
    }
    #tabs {
      display:flex;
      background:#fff;
      border-bottom:1px solid #ddd;
    }
    #tabs button {
      flex:1;
      padding:12px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:600;
    }
    #tabs button.active {
      border-bottom:3px solid #0288d1;
      color:#0288d1;
    }
    #chatHeader {
      padding:12px;
      background:#fafafa;
      border-bottom:1px solid #eee;
      font-weight:500;
      display:flex;
      align-items:center;
    }
    #chatHeader img {
      width:32px;
      height:32px;
      border-radius:50%;
      margin-right:8px;
      object-fit:cover;
    }
    .chatWindow {
      flex:1;
      padding:16px;
      background:#e8f5e9;
      overflow-y:auto;
    }
    .chatWindow.private { background:#fff3e0; }
    .message {
      margin:8px 0;
      max-width:70%;
      padding:8px 12px;
      border-radius:16px;
      position:relative;
      word-wrap:break-word;
    }
    .message.me {
      background:#0288d1;
      color:#fff;
      margin-left:auto;
    }
    .message.them {
      background:#e0e0e0;
      color:#000;
      margin-right:auto;
    }
    .message .meta {
      font-size:10px;
      opacity:0.7;
      position:absolute;
      bottom:-14px;
      right:8px;
    }
    .message.them .meta {
      color:#000;
    }
    .message.me .meta {
      color:#fff;
    }
    #inputArea {
      display:flex;
      padding:12px;
      background:#fff;
      border-top:1px solid #ddd;
    }
    #inputArea input[type=text] {
      flex:1;
      padding:10px;
      border:1px solid #ccc;
      border-radius:4px;
    }
    #inputArea input[type=file] { display:none; }
    #inputArea button {
      margin-left:8px;
      padding:0 12px;
      border:none;
      background:#0288d1;
      color:#fff;
      border-radius:4px;
      cursor:pointer;
      height:36px;
    }
    #inputArea .attach-btn {
      background:transparent;
      color:#555;
    }
    .empty-chat {
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height:100%;
      color:#888;
      text-align:center;
    }
  </style>
</head>
<body>

  <!-- =========== Sol Panel =========== -->
  <div id="sidebar">
    <div id="profile">
      <label for="profile-input">
        <img id="profile-img" src="" title="Profil fotoÄŸrafÄ±nÄ± deÄŸiÅŸtirmek iÃ§in tÄ±kla"/>
      </label>
      <input type="file" id="profile-input" accept="image/*"/>
      <input type="text" id="username" placeholder="KullanÄ±cÄ± adÄ±n"/>
      <button id="saveProfile">Kaydet</button>
      <div id="userIdDisplay"></div>
      <button id="copyIdBtn">ID'yi Kopyala</button>
    </div>

    <!-- ArkadaÅŸ Ekle -->
    <div id="addFriend">
      <input type="text" id="friendIdInput" placeholder="ArkadaÅŸ ID'si"/>
      <button id="addFriendBtn" title="Ekle"><span class="material-icons">person_add</span></button>
    </div>

    <!-- ArkadaÅŸ Listesi -->
    <ul id="friendsList"></ul>
  </div>

  <!-- =========== SaÄŸ Panel =========== -->
  <div id="chatPanel">
    <!-- Sekmeler -->
    <div id="tabs">
      <button data-tab="general" class="active">Genel</button>
      <button data-tab="private">Ã–zel</button>
    </div>

    <!-- BaÅŸlÄ±k -->
    <div id="chatHeader">
      <img id="headerImg" src="" style="display:none;"/>
      <span id="headerText">Genel Sohbet</span>
    </div>

    <!-- Genel Sohbet Penceresi -->
    <div id="generalWindow" class="chatWindow"></div>
    <!-- Ã–zel Sohbet Penceresi -->
    <div id="privateWindow" class="chatWindow private" style="display:none;">
      <div class="empty-chat">
        <span class="material-icons" style="font-size:48px; margin-bottom:8px;">person</span>
        <p>Bir arkadaÅŸ seÃ§erek Ã¶zel sohbet baÅŸlatÄ±n</p>
      </div>
    </div>

    <!-- Mesaj GiriÅŸ AlanÄ± -->
    <div id="inputArea">
      <button class="attach-btn" id="attachBtn" title="Dosya Ekle"><span class="material-icons">attach_file</span></button>
      <input type="file" id="fileInput" accept="image/*,video/*,.pdf,.doc,.zip"/>
      <input type="text" id="messageInput" placeholder="Mesaj yaz..." autocomplete="off"/>
      <button id="sendBtn">GÃ¶nder</button>
    </div>
  </div>

<script>
(function(){
  // -------- Firebase BaÅŸlatma --------
  const firebaseConfig = {
    apiKey: "AIzaSyD30unp7ap6R6sJoU8EEKRkqlyK-dPjuqM",
    authDomain: "genelchatprojesi.firebaseapp.com",
    databaseURL: "https://genelchatprojesi-default-rtdb.firebaseio.com",
    projectId: "genelchatprojesi",
    storageBucket: "genelchatprojesi.appspot.com",
    messagingSenderId: "751359781972",
    appId: "1:751359781972:web:da28a4695f9571736191c1"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // -------- DOM ElemanlarÄ± --------
  const profileImg   = document.getElementById('profile-img');
  const profileIn    = document.getElementById('profile-input');
  const usernameIn   = document.getElementById('username');
  const saveProfile  = document.getElementById('saveProfile');
  const userIdDisplay = document.getElementById('userIdDisplay');
  const copyIdBtn    = document.getElementById('copyIdBtn');
  const friendIn     = document.getElementById('friendIdInput');
  const addFriendBtn = document.getElementById('addFriendBtn');
  const friendsList  = document.getElementById('friendsList');
  const tabs         = document.querySelectorAll('#tabs button');
  const header       = document.getElementById('chatHeader');
  const headerImg    = document.getElementById('headerImg');
  const headerText   = document.getElementById('headerText');
  const genWin       = document.getElementById('generalWindow');
  const privWin      = document.getElementById('privateWindow');
  const attachBtn    = document.getElementById('attachBtn');
  const fileInput    = document.getElementById('fileInput');
  const msgInput     = document.getElementById('messageInput');
  const sendBtn      = document.getElementById('sendBtn');

  // -------- LocalStorage'dan Verileri Al --------
  let userId   = localStorage.getItem('userId');
  let username = localStorage.getItem('username');
  let profilePic = localStorage.getItem('profilePic');
  let friends  = JSON.parse(localStorage.getItem('friends')||'[]');
  let friendProfiles = JSON.parse(localStorage.getItem('friendProfiles')||'{}');

  // -------- Otomatik User ID OluÅŸtur --------
  if(!userId){
    userId = (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).substr(2,9));
    localStorage.setItem('userId', userId);
  }
  usernameIn.value = username || '';
  userIdDisplay.textContent = `ID: ${userId}`;
  if(profilePic) {
    profileImg.src = profilePic;
  } else {
    // VarsayÄ±lan avatar oluÅŸtur
    const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(username || 'U')}&background=random`;
    profileImg.src = defaultAvatar;
    profilePic = defaultAvatar;
  }

  // -------- ID Kopyalama --------
  copyIdBtn.onclick = () => {
    navigator.clipboard.writeText(userId).then(() => {
      copyIdBtn.textContent = 'KopyalandÄ±!';
      setTimeout(() => copyIdBtn.textContent = 'ID\'yi Kopyala', 2000);
    });
  };

  // -------- Profil Kaydetme --------
  saveProfile.onclick = () => {
    username = usernameIn.value.trim() || 'Anonim';
    localStorage.setItem('username', username);
    
    // Profil bilgilerini Firebase'e kaydet
    db.ref('users/' + userId).set({
      username: username,
      profilePic: profilePic
    });
    
    alert('Profil gÃ¼ncellendi!');
  };
  
  profileImg.onclick = () => profileIn.click();
  profileIn.onchange = e => {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      profilePic = ev.target.result;
      profileImg.src  = profilePic;
      localStorage.setItem('profilePic', profilePic);
      
      // Profil resmini Firebase'e kaydet
      if(username) {
        db.ref('users/' + userId).update({
          profilePic: profilePic
        });
      }
    };
    r.readAsDataURL(f);
  };

  // -------- ArkadaÅŸ Listesi --------
  function renderFriends(){
    friendsList.innerHTML = '';
    if(friends.length === 0) {
      const empty = document.createElement('li');
      empty.textContent = 'ArkadaÅŸ eklemek iÃ§in yukarÄ±daki alanÄ± kullanÄ±n';
      empty.style.cursor = 'default';
      empty.style.color = '#888';
      friendsList.appendChild(empty);
      return;
    }
    
    friends.forEach(fid => {
      const li = document.createElement('li');
      
      // ArkadaÅŸÄ±n profil resmini gÃ¶ster
      const img = document.createElement('img');
      img.src = friendProfiles[fid]?.profilePic || 'https://ui-avatars.com/api/?name=U&background=random';
      li.appendChild(img);
      
      const nameSpan = document.createElement('span');
      nameSpan.className = 'friend-name';
      nameSpan.textContent = friendProfiles[fid]?.username || fid;
      li.appendChild(nameSpan);
      
      li.onclick = () => {
        currentTab = 'private';
        switchTab();
        selectFriend(fid);
      };
      
      friendsList.appendChild(li);
    });
  }
  
  // ArkadaÅŸ profillerini gÃ¼ncelle
  function updateFriendProfiles() {
    friends.forEach(fid => {
      db.ref('users/' + fid).once('value').then(snap => {
        if(snap.exists()) {
          friendProfiles[fid] = snap.val();
          localStorage.setItem('friendProfiles', JSON.stringify(friendProfiles));
          renderFriends();
        }
      });
    });
  }
  
  addFriendBtn.onclick = () => {
    const fid = friendIn.value.trim();
    if(!fid || fid === userId) return alert('GeÃ§erli bir ID girin.');
    if(friends.includes(fid)) return alert('Bu kullanÄ±cÄ± zaten listenizde.');
    
    // Ã–nce bu ID'nin geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    db.ref('users/' + fid).once('value').then(snap => {
      if(!snap.exists()) return alert('Bu ID\'ye sahip kullanÄ±cÄ± bulunamadÄ±.');
      
      friends.push(fid);
      localStorage.setItem('friends', JSON.stringify(friends));
      
      // ArkadaÅŸÄ±n profil bilgilerini al
      db.ref('users/' + fid).once('value').then(snap => {
        friendProfiles[fid] = snap.val();
        localStorage.setItem('friendProfiles', JSON.stringify(friendProfiles));
        renderFriends();
        friendIn.value = '';
      });
    });
  };
  
  // Enter tuÅŸu ile arkadaÅŸ ekleme
  friendIn.addEventListener('keypress', (e) => {
    if(e.key === 'Enter') addFriendBtn.click();
  });

  // BaÅŸlangÄ±Ã§ta arkadaÅŸ listesini render et ve profilleri gÃ¼ncelle
  renderFriends();
  updateFriendProfiles();

  // -------- Sekme GeÃ§iÅŸi --------
  let currentTab = 'general';
  let currentFriend = null;
  
  tabs.forEach(btn => {
    btn.onclick = () => {
      currentTab = btn.dataset.tab;
      switchTab();
    };
  });
  
  function switchTab(){
    tabs.forEach(b => b.classList.toggle('active', b.dataset.tab === currentTab));
    
    if(currentTab === 'general') {
      headerText.textContent = 'Genel Sohbet';
      headerImg.style.display = 'none';
      genWin.style.display = 'flex';
      privWin.style.display = 'none';
    } else {
      if(currentFriend) {
        const friend = friendProfiles[currentFriend];
        headerText.textContent = friend?.username || currentFriend;
        headerImg.src = friend?.profilePic || 'https://ui-avatars.com/api/?name=U&background=random';
        headerImg.style.display = 'inline';
      } else {
        headerText.textContent = 'Ã–zel Sohbet';
        headerImg.style.display = 'none';
      }
      genWin.style.display = 'none';
      privWin.style.display = 'flex';
    }
  }

  // -------- Mesaj GÃ¶nderme --------
  attachBtn.onclick = () => fileInput.click();
  sendBtn.onclick = sendMessage;
  msgInput.addEventListener('keypress', (e) => {
    if(e.key === 'Enter') sendMessage();
  });
  fileInput.onchange = () => {
    if(fileInput.files[0]) sendMessage();
  };

  function sendMessage(){
    const txt = msgInput.value.trim();
    const file = fileInput.files[0];
    if(!txt && !file) return;

    const now = Date.now();
    const baseRef = currentTab === 'general'
      ? db.ref('chats/general')
      : db.ref('chats/private/' + sortedChatId);

    // Ã¶nce dosya yÃ¼kle, sonra mesajÄ± DB'ye it:
    if(file){
      const ext = file.name.split('.').pop();
      const path = `${currentTab}/${userId}_${now}.${ext}`;
      const uploadTask = storage.ref(path).put(file);
      uploadTask.on('state_changed', null, console.error, () => {
        uploadTask.snapshot.ref.getDownloadURL().then(url => {
          pushMsg(baseRef, txt, url, file.type);
        });
      });
    } else {
      pushMsg(baseRef, txt, null, null);
    }
    msgInput.value = ''; 
    fileInput.value = null;
  }

  function pushMsg(ref, text, fileUrl, fileType){
    ref.push({
      senderId: userId,
      senderName: username || 'Anonim',
      senderPic: profilePic || '',
      text: text || '',
      fileUrl: fileUrl || '',
      fileType: fileType || '',
      timestamp: Date.now()
    });
  }

  // -------- Genel Sohbet Dinleyici --------
  db.ref('chats/general').on('child_added', snap => {
    renderMessage(snap.val(), genWin);
  });

  // -------- Ã–zel Sohbet Dinleme --------
  let sortedChatId = '';
  function selectFriend(fid){
    currentFriend = fid;
    sortedChatId = [userId, fid].sort().join('_');
    
    // Ã–zel sohbet penceresini temizle ve baÅŸlÄ±ÄŸÄ± gÃ¼ncelle
    privWin.innerHTML = '';
    switchTab();
    
    // Ã–nceki dinleyiciyi kapat:
    db.ref('chats/private/' + sortedChatId).off();
    
    // Yeni dinleyici
    db.ref('chats/private/' + sortedChatId)
      .on('child_added', snap => renderMessage(snap.val(), privWin));
  }

  // -------- MesajÄ± DOM'a Ekle --------
  function renderMessage(msg, container){
    // EÄŸer boÅŸ mesaj penceresindeysek temizle
    if(container.querySelector('.empty-chat')) {
      container.innerHTML = '';
    }
    
    const div = document.createElement('div');
    div.className = 'message ' + (msg.senderId === userId ? 'me' : 'them');
    
    // Mesaj iÃ§eriÄŸi
    const content = document.createElement('div');
    
    // GÃ¶nderen bilgisi (sadece baÅŸkalarÄ±nÄ±n mesajlarÄ±nda)
    if(msg.senderId !== userId) {
      const sender = document.createElement('div');
      sender.style.fontWeight = 'bold';
      sender.style.marginBottom = '4px';
      
      if(msg.senderPic) {
        const img = document.createElement('img');
        img.src = msg.senderPic;
        img.style.width = '20px';
        img.style.height = '20px';
        img.style.borderRadius = '50%';
        img.style.marginRight = '6px';
        img.style.verticalAlign = 'middle';
        sender.appendChild(img);
      }
      
      sender.appendChild(document.createTextNode(msg.senderName));
      content.appendChild(sender);
    }
    
    // Metin
    if(msg.text) {
      const span = document.createElement('span');
      span.innerText = msg.text;
      content.appendChild(span);
    }
    
    // Dosya
    if(msg.fileUrl) {
      const br = document.createElement('br');
      content.appendChild(br);
      
      if(msg.fileType.startsWith('image')) {
        const i = document.createElement('img');
        i.src = msg.fileUrl;
        i.style.maxWidth = '200px';
        i.style.maxHeight = '200px';
        i.style.borderRadius = '8px';
        i.style.marginTop = '4px';
        content.appendChild(i);
      } else if(msg.fileType.startsWith('video')) {
        const v = document.createElement('video');
        v.src = msg.fileUrl; 
        v.controls = true; 
        v.style.maxWidth = '200px';
        v.style.maxHeight = '200px';
        v.style.borderRadius = '8px';
        v.style.marginTop = '4px';
        content.appendChild(v);
      } else {
        const a = document.createElement('a');
        a.href = msg.fileUrl; 
        a.target = '_blank';
        a.innerText = 'DosyayÄ± Ä°ndir';
        a.style.display = 'inline-block';
        a.style.marginTop = '4px';
        a.style.color = msg.senderId === userId ? '#fff' : '#0288d1';
        content.appendChild(a);
      }
    }
    
    div.appendChild(content);
    
    // Zaman
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerText = formatTime(msg.timestamp);
    div.appendChild(meta);

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }
  
  // ZamanÄ± formatla
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  // Ä°lk sekme ayarÄ±
  switchTab();
})();
</script>

</body>
</html>
